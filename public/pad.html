<script>
document.addEventListener("DOMContentLoaded", function () {

// ------------------ INITIAL VARIABLES ------------------
const padId = window.location.pathname.split('/').pop() || "default";
let saveTimeout, currentPassword = "";

document.getElementById("padName").textContent = padId;

// Make buttons NOT submit or reload
document.querySelectorAll("button").forEach(btn => btn.type = "button");

// ------------------ ELEMENTS ------------------
const landingPage = document.getElementById('landingPage');
const createPasswordScreen = document.getElementById('createPasswordScreen');
const enterPasswordScreen = document.getElementById('enterPasswordScreen');
const mainContent = document.getElementById('mainContent');

const btnCreateNew = document.getElementById('btnCreateNew');
const btnEnterExisting = document.getElementById('btnEnterExisting');
const backFromCreate = document.getElementById('backFromCreate');
const backFromEnter = document.getElementById('backFromEnter');

const createPasswordInput = document.getElementById('createPasswordInput');
const confirmPasswordInput = document.getElementById('confirmPasswordInput');
const createError = document.getElementById('createError');

const enterPasswordInput = document.getElementById('enterPasswordInput');
const enterError = document.getElementById('enterError');

const submitCreate = document.getElementById('submitCreate');
const submitEnter = document.getElementById('submitEnter');

const editor = document.getElementById('editor');
const status = document.getElementById('status');

const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

const filesList = document.getElementById('filesList');
const errorContainer = document.getElementById('errorContainer');

const previewModal = document.getElementById('previewModal');
const previewTitle = document.getElementById('previewTitle');
const previewBody = document.getElementById('previewBody');
const closePreview = document.getElementById('closePreview');

const infoModal = document.getElementById('infoModal');
const menuBtn = document.getElementById('menuBtn');
const closeInfoBtn = document.getElementById('closeInfoBtn');

// Always use safe origin for Render
function api(path) {
    return `${window.location.origin}${path}`;
}

// ------------------ UI Navigation ------------------
function showScreen(screen) {
    landingPage.classList.add('hidden');
    createPasswordScreen.classList.add('hidden');
    enterPasswordScreen.classList.add('hidden');
    mainContent.classList.add('hidden');

    if (screen === 'landing') landingPage.classList.remove('hidden');
    if (screen === 'create') { createPasswordScreen.classList.remove('hidden'); createPasswordInput.focus(); }
    if (screen === 'enter') { enterPasswordScreen.classList.remove('hidden'); enterPasswordInput.focus(); }
    if (screen === 'main') mainContent.classList.remove('hidden');
}

btnCreateNew.onclick = () => showScreen("create");
btnEnterExisting.onclick = () => showScreen("enter");
backFromCreate.onclick = () => showScreen("landing");
backFromEnter.onclick = () => showScreen("landing");

// ------------------ CREATE PASSWORD ------------------
submitCreate.onclick = async () => {
    const p1 = createPasswordInput.value.trim();
    const p2 = confirmPasswordInput.value.trim();

    if (!p1) return showError(createError, "Please enter a password");
    if (p1.length < 4) return showError(createError, "Password must be at least 4 characters");
    if (p1 !== p2) return showError(createError, "Passwords do not match");

    submitCreate.disabled = true;
    submitCreate.textContent = "Creating...";

    try {
        const res = await fetch(api(`/api/pad/${padId}/create`), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: p1 })
        });

        const data = await res.json();

        if (data.success) {
            currentPassword = p1;
            showScreen("main");
            loadPad();
        } else {
            showError(createError, data.error || "Failed to create pad");
        }

    } catch {
        showError(createError, "Connection error");
    }

    submitCreate.disabled = false;
    submitCreate.textContent = "Create & Start Using";
};

// ------------------ ENTER PASSWORD ------------------
submitEnter.onclick = async () => {
    const password = enterPasswordInput.value.trim();
    if (!password) return showError(enterError, "Enter your password");

    submitEnter.disabled = true;
    submitEnter.textContent = "Verifying...";

    try {
        const res = await fetch(api(`/api/pad/${padId}/verify`), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
            currentPassword = password;
            showScreen("main");
            loadPad();
        } else {
            showError(enterError, "Incorrect password");
        }

    } catch {
        showError(enterError, "Connection error");
    }

    submitEnter.disabled = false;
    submitEnter.textContent = "Access My Pad";
};

// ------------------ ERROR HELPERS ------------------
function showError(el, msg) {
    el.textContent = msg;
    el.classList.remove("hidden");
    setTimeout(() => el.classList.add("hidden"), 3000);
}

function showErrorMain(msg) {
    errorContainer.innerHTML = `<div class="error">${msg}</div>`;
}

function clearErrorMain() {
    errorContainer.innerHTML = "";
}

// ------------------ LOAD PAD ------------------
async function loadPad() {
    try {
        const res = await fetch(api(`/api/pad/${padId}/get`), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: currentPassword })
        });

        const data = await res.json();
        editor.value = data.content || "";
        renderFiles(data.files || []);
    } catch {
        showErrorMain("Failed to load pad");
    }
}

// ------------------ AUTO SAVE ------------------
editor.oninput = () => {
    clearTimeout(saveTimeout);
    status.textContent = "Typing...";

    saveTimeout = setTimeout(async () => {
        try {
            await fetch(api(`/api/pad/${padId}/save`), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: currentPassword, content: editor.value })
            });
            status.textContent = "Saved ✓";
        } catch {
            status.textContent = "Save failed";
        }
    }, 800);
};

// ------------------ UPLOAD ------------------
uploadBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
    if (fileInput.files.length > 0) uploadFile(fileInput.files[0]);
};

async function uploadFile(file) {
    clearErrorMain();

    if (file.size > 10 * 1024 * 1024)
        return showErrorMain("File too large (max 10MB)");

    const form = new FormData();
    form.append("file", file);
    form.append("password", currentPassword);

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploading...";

    try {
        const res = await fetch(api(`/api/upload/${padId}`), { method: "POST", body: form });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error);
        loadPad();
    } catch (err) {
        showErrorMain(err.message);
    }

    uploadBtn.disabled = false;
    uploadBtn.textContent = "Choose File";
}

// ------------------ FILE LIST ------------------
function renderFiles(files) {
    if (files.length === 0) {
        filesList.innerHTML = `<div class="empty-state">No files yet</div>`;
        return;
    }

    filesList.innerHTML = files.map(file => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">${file.size} bytes</div>
            </div>
            <div class="file-actions">
                <button class="download-btn" onclick="downloadFile('${file.id}','${file.name}')">⬇ Download</button>
            </div>
        </div>
    `).join("");
}

// ------------------ DOWNLOAD ------------------
async function downloadFile(id, name) {
    try {
        const res = await fetch(api(`/files/${padId}/${id}`), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: currentPassword })
        });

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        a.click();
    } catch {
        showErrorMain("Download failed");
    }
}

// ------------------ INFO MODAL ------------------
menuBtn.onclick = () => infoModal.classList.add("active");
closeInfoBtn.onclick = () => infoModal.classList.remove("active");
infoModal.onclick = e => { if (e.target === infoModal) infoModal.classList.remove("active"); };

}); // END OF DOMContentLoaded
</script>
